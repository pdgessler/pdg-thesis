\chapter{Theoretical Model Development} \label{cha:modeldev}
This chapter presents the development of the equations used to model 
the compressor test block from first principles. 
\Cref{sec:GenBal} contains the general mass and energy balance equations, 
to which the appropriate assumptions for each device in the cycle are applied 
to produce the device-specific equations, as detailed in \crefrange{sec:Compressor}{sec:Mixing}. 
Subscripts $\text{i}\nomenclature[X]{$\text{i}$}{Inlet conditions}$ 
and $\text{o}\nomenclature[X]{$\text{o}$}{Outlet conditions}$ 
are used to indicate the inlet and outlet states of the device, respectively. 

\section{General Balance Equations} \label{sec:GenBal}
Throughout the model, the rate forms of the balance equations are used 
since compressor test data from the block are recorded once steady-flow conditions are reached. 
This section lists the mass and energy balances in their most general form \parencite{cengel2011}, 
so that engineering assumptions may be applied on a per-device basis.

The general mass balance is obtained by 
applying conservation of mass to the control volume. 
This process yields
\begin{equation}
	\dod{m_\CV}{t} = \sum_{\text{inlets}}{\dot{m}} - \sum_{\text{outlets}}{\dot{m}},
  \label{eqn:GenMass}
	\nomenclature{$t$}{Time\nomunit{\minute}} 
  \nomenclature{$m$}{Mass\nomunit{\poundmass}} 
	\nomenclature[X]{$\CV$}{Control volume}
\end{equation}
where the summations account for any number of inlets and outlets to the device.
\Cref{eqn:GenMass} includes only transport terms since mass production is 
always identically zero (neglecting nuclear processes).
This result is applied to each device in the cycle, with the appropriate number of inputs and outputs.

Similarly, the general energy balance is obtained by writing 
an extensive property balance over the control volume. 
By the first law of thermodynamics, energy production is identically zero 
(again, neglecting nuclear processes), so only transport terms remain in the equation. 
Here though, heat transfer and work transfer interactions, and kinetic and potential energy changes
can change the energy of the control volume in addition to the transport terms, so
\begin{equation}
	\dod{E_\CV}{t} = \dot{Q} - \dot{W} + \sum_{\text{inlets}}{\dot{m}h^{\circ}} - 
		\sum_{\text{outlets}}{\dot{m}h^{\circ}},
  \label{eqn:GenEnergy}
	\nomenclature{$e$}{Specific energy, $e=u+\text{ke}+\text{pe}$\nomunit{\btu\per\poundmass}} 
	\nomenclature{$Q$}{Heat transfer\nomunit{\btu}} 
	\nomenclature{$W$}{Work transfer\nomunit{\btu}} 
	\nomenclature[Y]{$\dot{\left(\;\right)}$}{Quantity per unit time or rate, $\dif{\left(\;\right)}/\mkern-3mu\dif{t}$\nomunit{$\left[\;\right]$\per\minute}} 
	\nomenclature{$p$}{Pressure\nomunit{\psia,\,\psig,\,\psid}}
	\nomenclature{$v$}{Specific volume\nomunit{\foot\cubed\per\poundmass}}
	\nomenclature{$u$}{Specific internal energy\nomunit{\btu\per\poundmass}}
  \nomenclature[A$z$]{*}{Unless otherwise noted, symbols for extensive properties are the uppercase variants of symbols used for the corresponding specific (intensive) properties.}
\end{equation}
where the \emph{methalpy}, $h^\circ = h+\mathrm{ke}+\mathrm{pe}%
  \nomenclature{$h^{\circ}$}{Specific methalpy, $h^\circ=h+\mathrm{ke}+\mathrm{pe}$\nomunit{\btu\per\poundmass}}$, 
is a convenient way to account for kinetic and potential energy effects if required. 
The methalpy can be calculated from the enthalpy $h\nomenclature{$h$}{Specific enthalpy, $h=u+pv$\nomunit{\btu\per\poundmass}}$,
the kinetic energy
\begin{equation}
  \mathrm{ke} = \vel^2/2,
  \nomenclature[A$k$]{$\mathrm{ke}$}{Specific kinetic energy, $\mathrm{ke}=\vel^2/2$\nomunit{\btu\per\poundmass}}
  \nomenclature[A$V$]{$\vel$}{Velocity magnitude\nomunit{\foot\per\minute}}
\end{equation}
where the average velocity $\vel$ can be calculated using 
$\dot{m}=\rho \vel A%
  \nomenclature[W]{$\rho$}{Density, $1/v$\nomunit{\poundmass\per\foot\cubed}}%
  \nomenclature{$A$}{Area\nomunit{\foot\squared,\,\inch\squared}}$, and the potential energy
\begin{equation}
  \mathrm{pe} = gz,
	\nomenclature[A$p$]{$\mathrm{pe}$}{Specific potential energy, $\mathrm{pe}=gz$\nomunit{\btu\per\poundmass}}
	\nomenclature{$g$}{Gravitational acceleration, $g=\IP{115826}{\foot\per\minute\squared}$\nomunit{\foot\per\minute\squared}}
	\nomenclature{$z$}{Elevation\nomunit{\foot}}
\end{equation}
where $g$ is the gravitational acceleration 
and $z$ is the elevation of the inlet/outlet.

\Cref{eqn:GenEnergy} shows the standard sign convention used throughout this thesis; 
that is, heat transfer \emph{into} the system is considered positive, 
while work transfer \emph{out of} the system is considered positive.
\Cref{eqn:GenMass,eqn:GenEnergy} form the basic equations to which 
engineering assumptions are applied in \crefrange{sec:Compressor}{sec:Mixing}.
Assumptions common to each device in the cycle are that
\begin{enumerate}
  \item the steady-flow condition leads to both time derivatives $\dif{m_\CV}/\!\dif{t} = \dif{E_\CV}/\!\dif{t} = 0$, \label{lst:sf}
  \item changes in potential energy are neglected, so $\Delta \text{pe} = 0$, and \label{lst:pe}
  \todo{generalize for MISO or SIMO devices?}
  \item changes in kinetic energy are neglected, so $\Delta \text{ke} = 0$. \label{lst:ke}
\end{enumerate}
As a consequence of assumptions~\ref{lst:pe} and~\ref{lst:ke},
we can reduce the methalpy notation to the more familiar enthalpy form,
and assumption~\ref{lst:sf} means that the left-hand sides of \cref{eqn:GenMass,eqn:GenEnergy} both become zero:
\begin{align}
  0 &= \sum_{\text{inlets}}{\dot{m}} - \sum_{\text{outlets}}{\dot{m}}, \label{eqn:SemiMass}\\
  0 &= \dot{Q} - \dot{W} + \sum_{\text{inlets}}{\dot{m}h} - \sum_{\text{outlets}}{\dot{m}h}. \label{eqn:SemiEnergy}
\end{align}
\cref{eqn:SemiMass,eqn:SemiEnergy} are used as the basis for all component models
in \crefrange{sec:Compressor}{sec:Mixing}.

\section{Compressor} \label{sec:Compressor}
Detailed modeling of the compressor is complex and worthy of a dissertation in its own right. 
To make matters worse, the model should make reasonable predictions 
of a compressor test for \emph{any} compressor, 
whether already prototyped or in the early stages of development.
Fortunately, detailed compressor models are not required 
to predict compressor performance for the purposes test block modeling. 
The performance of the compressor is calculated by the model using
data from compressor maps. 
An example of a typical compressor map is shown in \cref{fig:GenMap}. 
\note{Don't worry, this isn't one of yours, JT and Steve! :)}
\begin{figure}[htbp]
  \centering
  \includegraphics{figs/GenericCompMap}
  \caption{Typical compressor map, showing flow and head axes, speed lines, and efficiency islands.
    The operating region for the compressor is the region bounded by the surge and choke lines.}
  \label{fig:GenMap}
\end{figure}
These compressor maps are developed by JCI either 
experimentally for existing compressors or numerically%
---using other compressor design tools, from basic one-dimensional methodologies
to full three-dimensional CFD---for new compressor designs.

A user of the model can select an operating point on the compressor map, 
and with specification of the suction (inlet) conditions, 
the discharge (outlet) state of the compressor is fixed. 
Dimensionless coefficients of flow, head, and velocity
($\Theta$, $\Omega$, and $\MA$, respectively) are used 
to generalize the compressor maps to machine characteristics. 
The flow coefficient $\Theta$ \parencite{trevino2012} is given by
\begin{equation}
  \Theta = \frac{\dot{V}}{\svel D^2},
	\nomenclature{$\svel$}{Acoustic (sonic) velocity\nomunit{\foot\per\minute}}
	\nomenclature[W]{$\Theta$}{Flow coefficient, $\dot{V}/{\svel D^2}$\nomunit{-}}
\end{equation}
where $\dot{V}$ is the volumetric flow rate, 
$\svel$ is the acoustic (sonic) velocity at total suction conditions, 
and $D$ is the impeller tip diameter.
The head coefficient $\Omega$ \parencite{trevino2012} is given by
\begin{equation}
	\Omega = \frac{g_c \Delta h_s}{\svel^2},
	\nomenclature[W]{$\Omega$}{Isentropic head coefficient, ${g_c \Delta h_s}/{\svel^2}$\nomunit{-}}
	\nomenclature{$g_c$}{Gravitational proportionality constant, $g_c=\IP{115826}{\poundmass\foot\per\poundforce\minute\squared}$\nomunit{\poundmass\foot\per\poundforce\minute\squared}}
\end{equation}
where $g_c$ is the gravitational proportionality constant, 
$\Delta h_s$ is the specific enthalpy change for an isentropic compression process, 
and $\svel$ is, again, the acoustic velocity at total suction conditions.

The Machine Mach number $\MA$ is 
\begin{equation}
  \MA = \frac{\vel_{\text{tip}}}{a},
  \nomenclature[A$Ma$]{$\MA$}{Machine Mach number, $\vel_{\text{tip}}/a$\nomunit{-}}
\end{equation}
where $\vel_{\text{tip}}$ is the impeller tip velocity
and $a$ is the acoustic velocity at total inlet (suction) conditions \parencite{trevino2012}.
The third and final compressor performance characteristic gleaned 
from the compressor map is the isentropic efficiency, $\eta_s$, 
which quantifies the deviation of the real compression process 
from an isentropic (adiabatic and reversible) compression process. 
The isentropic efficiency \parencite{cengel2011} is defined as
\begin{equation}
  \eta_s = \frac{h_{\text{o}s}-h_{\text{i}}}{h_{\text{o}}-h_{\text{i}}},
  \nomenclature[X]{$s$}{Isentropic} 
  \nomenclature[W]{$\eta$}{Efficiency\nomunit{-}}
\end{equation}
where $h_{\text{o}s}$ is the discharge enthalpy for an isentropic compression process, 
$h_{\text{i}}$ is the suction enthalpy, 
and $h_{\text{o}}$ is the actual discharge enthalpy. 

While the model uses isentropic efficiency $\eta_s$, 
the efficiency islands on standard compressor maps plot a corrected efficiency $\eta_{\text{map}}$,
which includes a correction for the Reynolds number at the given operating point.
To convert the corrected map efficiency into isentropic efficiency \parencite{kauffman2006}, 
we use the transformation
\begin{equation}
  \eta_s = \eta_{\text{map}} + X(1 - \eta_{\text{peak}})\left(1-\left(\frac{10^6}{\RE_b}\right)^{0.1}\right),
\end{equation}
where the flow ratio $X = \max{(1,\Theta/\Theta_{\text{peak}})}\nomenclature{$X$}{Flow ratio, $X=\max{(1,\Theta/\Theta_{\text{peak}})}$\nomunit{-}}$, 
$\Theta_{\text{peak}}$ is the flow coefficient 
corresponding to the point of maximum map efficiency,
$\eta_{\text{peak}}$ is the maximum map efficiency,
and $\RE_b$ is the Reynolds number 
based on impeller tip width $b$%
\nomenclature{$b$}{Impeller tip width\nomunit{\foot}}; that is,
\begin{equation}
\text{Re}_b=\frac{\rho \vel b}{\mu},
\nomenclature[A$Re$]{$\RE_L$}{Reynolds number based on characteristic length $L$, $\text{Re}_L=\rho \vel L/\mu$\nomunit{-}}
\nomenclature[W]{$\mu$}{Dynamic viscosity\nomunit{\poundforce\minute\per\foot\squared}}
\end{equation}
with fluid properties evaluated at total suction conditions.

The four map parameters for the desired operating point 
($\Theta$, $\Omega$, $\MA$, and $\eta_{\text{map}}$), 
specified suction conditions ($T_{\text{i}}$ and $p_{\text{i}}$), 
and machine characteristics ($D$, $b$, $\Theta_{\text{peak}}$, and $\eta_{\text{peak}}$) 
allow the model to compute the discharge conditions ($T_{\text{o}}$ and $p_{\text{o}}$) 
and mass flow rate $\dot{m}$. 
A flowchart showing this calculation process is shown in \cref{cha:solnmethod}.
\todo{update cross-reference to flowchart.}

Once the inlet and outlet states at the compressor are known, 
the mass and energy balances can be revisited. 
From \cref{eqn:SemiMass,eqn:SemiEnergy} and
assuming that the compressor can be modeled as a 
single-input, single-output (SISO) device (no leakage assumption), we have
\begin{align}
  &\text{Mass:}   & 0 &= {\dot{m}_{\text{i}}} - {\dot{m}_{\text{o}}} \label{eqn:CompMass}\\
  &\text{Energy:} & 0 &= \dot{Q} - \dot{W} + {\dot{m}_{\text{i}}h_{\text{i}}} - 
		{\dot{m}_{\text{o}}h_{\text{o}}} \label{eqn:CompEnergy}.
\end{align}
\note{Using `we' is a habit of mine in derivations. OK or should I lose it?}
\Cref{eqn:CompMass} simply means that the mass flow 
entering the compressor is equal to that leaving the compressor. 
In \cref{eqn:CompEnergy}, we know the mass flow rates from the 
calculation procedure with the compressor map parameters. 
Finally, assuming that the compressor is well-insulated; 
that is, $\dot{Q}=0$, leaves $\dot{W}$ 
as the sole remaining unknown in \cref{eqn:CompEnergy}. 
This value is one of the requirements of the model. 

The value calculated for $\dot{W}$ in the compressor is known
as the \emph{gas horsepower}. The actual power requirements of the
prime mover are slightly larger as a result of mechanical inefficiencies
in the speed-increasing gearbox and compressor itself.
These losses are modeled assuming the form
\begin{equation}
  \dot{W}_{\text{gas}} = \eta_{\text{mech}}\dot{W}_{\text{mech}},
\end{equation}
with an empirical mechanical efficiency factor $\eta_{\text{mech}}$
which is discussed further in \cref{cha:solnmethod}.

\section{Orifice Flow Meter} \label{sec:Orifice}
\textcite{ptc19} presents correlations relating the orifice pressure drop to the
flow rate for flow measurement purposes.
In the model, the flow rate is known and the pressure drop is to be predicted,
in order to facilitate orifice selection.
The relationships listed in this section hold for flange taps as used
on the \IP{1500}{\horsepower} test block's three flow measurement stations.

First, the volume flow rate based on the conditions 
upstream of the orifice is given by
\begin{equation}
  \dot{V} = \dot{m}_{\text{i}}v_{\text{i}},
\end{equation}
which is used elsewhere in the correlations.
The orifice (diameter $d$) and 
pipe (diameter $D_{\text{pipe}}$) cross-sectional areas, 
respectively, are given by
\begin{align}
  A_d &= \frac{\pi}{4} d^2 
  \nomenclature{$d$}{Orifice diameter\nomunit{\inch}} \\
  \shortintertext{and}
  A_D &= \frac{\pi}{4} D_{\text{pipe}}^2.
  \nomenclature{$D$}{Diameter\nomunit{\foot,\,\inch}}
\end{align}
Then  the average velocity $\vel_D$ in the pipe is
\begin{align}
  \vel_D &= \dot{V}/A_D, \\
  \intertext{and the corresponding Reynolds number is}
  \RE_{D,\text{ pipe}} &= \frac{\rho_{\text{i}} \vel_D D_{\text{pipe}}}{\mu_{\text{i}}}.
\end{align}
Similar results follow at the orifice, using $d$ and $A_d$ instead.
Even though compressibility effects are allowed, we assume that using the inlet properties
is valid for the calculations at the orifice location, since the effect of compressibility
on thermophysical properties will be small over the pressure drop across the orifice.

For convenience, PTC~19.5 also defines a ratio of diameters, 
$\beta = {d}/{D_{\text{pipe}}}%
\nomenclature[W]{$\beta$}{Ratio of orifice diameter to pipe diameter, $\beta = d/D$\nomunit{-}}$,
which is used throughout the calculations.
For flange taps, the correlations take a nested form, with the orifice 
coefficient of discharge $C$ represented by
\begin{align}
C &= K\sqrt{1-\beta^4},
\nomenclature{$C$}{Orifice coefficient of discharge\nomunit{-}}\\
\shortintertext{where the flow coefficient}
K &= K_0 \left(1+\frac{\alpha}{\RE_d}\right).
\nomenclature{$K_{(\;)}$}{Flow coefficients for orifice correlations; refer to \cref{sec:Orifice} for details\nomunit{-}}
\end{align}
Here,
\begin{equation}
\alpha = d\left(\IP{830}{\per\inch} - (\IP{5000}{\per\inch})\beta + (\IP{9000}{\per\inch})\beta^2 - (\IP{4200}{\per\inch})\beta^3 + \frac{\IP{530}{\per\inch^{0.5}}}{\sqrt{D}}\right)
\end{equation}
and
\begin{equation}
K_0 = K_e \left(\frac{10^6 d}{10^6 d + (\IP{15}{\inch})\alpha}\right).
\end{equation}
The particular form of $K_e$ uses singularity function notation; that is,
if the quantity in angle brackets is negative, that term becomes zero.
\begin{multline}
K_e = 0.5993 + \frac{\IP{0.007}{\inch}}{D} + \left(0.364 + \frac{\IP{0.076}{\inch^{0.5}}}{\sqrt{D}}\right)\beta^4 
      + 0.4\left(1.6 - \frac{\IP{1}{\inch}}{D}\right)^5 \langle 0.07 + {\IP{0.5}{\inch}}/{D} - \beta\rangle^{5/2} \\
      - \left(0.009 + \frac{\IP{0.034}{\inch}}{D}\right) \langle0.5 - \beta\rangle^{3/2} 
      + \left(\frac{\IP{65}{\inch\squared}}{D^2} + 3\right)\langle\beta - 0.7\rangle^{5/2}.
\end{multline}

To account for the compressibility of the refrigerant, PTC~19.5 defines
the expansion factor,
\begin{equation}
Y = 1 - (0.41 + 0.35 \beta^4) \frac{\Delta p}{p_{\text{i}}\gamma},
\nomenclature{$Y$}{Expansion factor\nomunit{-}}
\end{equation}
where $\Delta p$ is the orifice differential pressure, $p_{\text{i}}-p_{\text{o}}$, and
$\gamma\nomenclature[W]{$\gamma$}{Ratio of specific heats, $\gamma = c_p/c_v$\nomunit{-}}$ 
is the ratio of specific heats (evaluated at upstream conditions), 
$\gamma = c_p/c_v\nomenclature{$c_p$, $c_v$}{Specific heats, constant pressure and volume, respectively\nomunit{\btu\per\poundmass\rankine}}$.
\nomenclature{$x$}{Quality\nomunit{-}}%
\nomenclature[X]{$i$}{The $i$th component/element of a mixture/series}%
\nomenclature[Y]{$\Delta\left(\;\right)$}{Change in quantity; for example, $\text{final} - \text{initial or outlet} - \text{inlet}$\nomunit{$\left[\;\right]$}}%
\nomenclature[X]{$\text{sh}$}{Superheat}%
\nomenclature[0]{\textbf{Symbol}}{\textbf{Description}\nomunit{\textbf{Units}}}%
The model also has provisions for choked flow, which may occur when 
running the orifice selection routine in large flow ranges with the smaller orifices.
From \textcite{munson2009}, 
\begin{equation}
p_{\text{o, choked}} = p_{\text{i}} \left(\frac{2}{\gamma+1}\right)^{\gamma/(\gamma-1)};
\end{equation}
and if $p_{\text{o, choked}} > p_{\text{o, free}}$, where free denotes the un-choked condition, the flow is said to be choked.
The model selects the larger of the two pressures to continue calculations.
Ultimately, the compressible orifice equation is used to predict the differential pressure based on mass flow rate:
\begin{equation}
\dot{m} = C Y A_d \sqrt{2\rho_{\text{i}} \Delta p}.
\end{equation}

In addition to the pressure calculations, mass and energy balances are required
for this single-input, single-output device:
\begin{align}
  &\text{Mass:}   & 0 &= {\dot{m}_{\text{i}}} - {\dot{m}_{\text{o}}} \to {\dot{m}_{\text{o}}} = {\dot{m}_{\text{i}}} \label{eqn:OrifMass}\\
  &\text{Energy:} & 0 &= \dot{Q} - \dot{W} + {\dot{m}_{\text{i}}h_{\text{i}}} - 
		{\dot{m}_{\text{o}}h_{\text{o}}} \label{eqn:OrifEnergy}.
\end{align}
For the orifice, we assume a rigid control volume and no shaft work, and additionally
assume the orifice is well-insulated. So $\dot{Q}=\dot{W}=0$, and thus 
$h_{\text{o}} = h_{\text{i}}$ for the orifice.

\section{Flow Split} \label{sec:FlowSplit}
The flow split is assumed to be rigid and well-insulated.
Additionally, we assume that the two outlet states are the same as the inlet state.
The actual division of mass flow rate is determined elsewhere in the model, 
by requiring that the throttled condensed stream mix with the throttled hot gas bypass
stream in the correct proportion to re-establish the specified compressor suction condition.
So for the flow split, it is sufficient to specify the outlet states equal to the inlet:
\begin{align}
  T_{\text{o}} &= T_{\text{o, HGBP}} = T_{\text{i}}, \\
  p_{\text{o}} &= p_{\text{o, HGBP}} = p_{\text{i}}, \\
  \shortintertext{and}
  x_{\text{o}} &= x_{\text{o, HGBP}} = x_{\text{i}},  
\end{align}
where subscript $\text{o}$ indicates the main outlet flow stream (leading to the condenser)
and subscript $\text{o, HGBP}$ indicates the flow stream bypassing the condenser.

\section{Condenser} \label{sec:Condenser}
In the condenser, we assume constant pressure for both the water and refrigerant
streams and assume a rigid control volume and no shaft work so that $\dot{W}=0$.

\section{Cooling Tower} \label{sec:CoolingTower}
\begin{align*}
  c = 1.684; &\quad n = - 0.391 \\
  \NTU &= c\left(\frac{\dot{m}_{w,i}}{\dot{m}_{a,i}}\right)^{1 + n}
\end{align*}

\section{Expansion Devices} \label{sec:Expand}
The actual gas test block cycle has a complicated arrangement 
of numerous valves and spray nozzles which simultaneously throttle and mix 
the condensed refrigerant stream with the bypassed refrigerant stream 
to reestablish the compressor suction conditions.
For the purposes of a one-dimensional model, this complex arrangement
may be separated into three distinct processes: 
throttling the condensed refrigerant stream to the cycle's low pressure (suction pressure),
throttling the hot gas bypass refrigerant stream to the cycle's low pressure, and
mixing the two refrigerant streams in the correct proportions 
to achieve the specified test suction conditions.

While the condensed refrigerant stream is a subcooled liquid 
or saturated liquid-vapor mixture and the hot gas bypass refrigerant stream
is a superheated vapor, the theory for the throttling process is the same
in both cases, as described in this section.
The theory for the mixing process is described in \cref{sec:Mixing}.

\section{Mixing Chamber} \label{sec:Mixing}

